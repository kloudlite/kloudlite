---
global:
  accountName: kloudlite-dev
  clusterName: sample-cluster

  providerNamespace: kl-account-kloudlite-dev
  providerName: aws-creds
  newProviderName: aws-creds3

---

label: Create Cloud Provider Secret
query: |+
  mutation Infra_createProviderSecret($secret: CloudProviderSecretIn!) {
    infra_createProviderSecret(secret: $secret) {
      id
    }
  }
variables:
  secret:
    displayName: "{{.providerName}}"
    metadata:
      name: "{{.newProviderName}}"
    cloudProviderName: aws
    aws:
      awsAccountId: "{{.awsAccountId}}"
    # stringData:
    #   accessKey: "{{.awsAccessKey}}"
    #   accessSecret: "{{.awsAccessSecret}}"

---

label: Update Cloud Provider Secret
query: |+
  mutation Infra_updateProviderSecret($secret: CloudProviderSecretIn!) {
    infra_updateProviderSecret(secret: $secret) {
      id
    }
  }
variables:
  secret:
    displayName: "{{.providerName}}"
    metadata:
      name: "{{.newProviderName}}"
    cloudProviderName: aws
    aws:
      awsAccountId: "{{.awsAccountId}}"

---

label: List Provider Secrets
query: |+
  query Infra_listProviderSecrets($search: SearchProviderSecret) {
    infra_listProviderSecrets(search: $search) {
      edges {
        node {
          markedForDeletion
          accountName
          metadata {
            name
            namespace
          }
          aws {
            awsAccountId
            awsAssumeRoleExternalId
            awsAssumeRoleRoleARN
          }
        }
      }
    }
  }
variables:
  search:
    cloudProviderName:
      matchType: 'regex'
      regex: '^aws$'

---

label: Get Provider Secret
query: |+
  query Infra_getProviderSecret($name: String!) {
    infra_getProviderSecret(name: $name) {
      accountName
      metadata {
        name
      } 
      cloudProviderName
      stringData
    }
  }
variables:
  name: "{{.providerName}}"
---

label: Delete Provider Secret
query: |+
  mutation Infra_deleteProviderSecret($secretName: String!) {
    infra_deleteProviderSecret(secretName: $secretName)
  }
variables:
  # secretName: "{{.providerName}}"
  secretName: "{{.newProviderName}}"
---

---
label: Check AWS Access
query: |+
  query Infra_checkAWSAccess($cloudproviderName: String!) {
    infra_checkAwsAccess(cloudproviderName: $cloudproviderName) {
      result
      installationUrl
    }
  }
variables:
  cloudproviderName: "{{.newProviderName}}"
---

