version: 3

# includes:
#   grpc: 
#     taskfile: ./grpc-interfaces/Taskfile.yml
#     dir: ./grpc-interfaces

tasks:
  run:auth:
    desc: Run the auth service
    dir: ./apps/auth
    cmds:
      - task run

  run:comms:
    desc: Run the auth service
    dir: ./apps/comms
    cmds:
      - task run
    
  go:upgrade:github.com/kloudlite/operator:
    cmds:
      - go list -m -json github.com/kloudlite/operator@{{.commit}} | jq '.|"\(.Path) \(.Version)"'

  mocks:
    cmds:
      - |+
        function gen_mock() {
          package_path=$1
          interface_name=$2

          banner="// Code generated by mocki. DO NOT EDIT."

          mock_module_path=$(echo $package_path | sed 's/github.com\/kloudlite\/api\///')
          file_name=$(echo $interface_name | awk '{print tolower($0)}')
          file_name+=".go"

          if [ ! -z $(echo $package_path | grep -i '/internal/') ]; then
            printf "mocking $package_path.$interface_name "

            mkdir -p $mock_module_path/mocks
            echo "$banner" > $mock_module_path/mocks/$file_name
            mocki --package $package_path --interface $interface_name >> $mock_module_path/mocks/$file_name
            echo "✅"
            return
          fi

          printf "mocking $package_path.$interface_name "
          mkdir -p mocks/$mock_module_path
          set -x 
          whereis mocki
          mocki --package $package_path --interface $interface_name > mocks/$mock_module_path/$file_name
          set +x
          echo "✅"
        }

        gen_mock github.com/kloudlite/api/pkg/repos DbRepo

        gen_mock github.com/kloudlite/api/pkg/k8s Client

        # gen_mock github.com/kloudlite/api/apps/infra/internal/domain AccountsSvc
        #
        # gen_mock github.com/kloudlite/api/grpc-interfaces/github.com/kloudlite/api/rpc/iam IAMClient
        # gen_mock github.com/kloudlite/api/grpc-interfaces/github.com/kloudlite/api/rpc/accounts AccountsClient
        # gen_mock github.com/kloudlite/api/grpc-interfaces/github.com/kloudlite/api/rpc/message-office-internal MessageOfficeInternalClient
        #
        # gen_mock github.com/kloudlite/api/pkg/kafka Producer
        # gen_mock github.com/kloudlite/api/pkg/kafka Consumer

      # - mkdir -p pkg/repos/mocks
      # - mocki --package github.com/kloudlite/api/pkg/repos --interface DbRepo > pkg/repos/mocks/db-repo.go
      #
      # - mkdir -p pkg/k8s/mocks
      # - mocki --package github.com/kloudlite/api/pkg/k8s --interface ExtendedK8sClient  > pkg/k8s/mocks/extended-k8s-client.go
      #
      # # grpc-interfaces mocks
      # - mkdir -p mocks/grpc-interfaces/github.com/kloudlite/api/rpc/iam
      # - mocki --package github.com/kloudlite/api/grpc-interfaces/github.com/kloudlite/api/rpc/iam --interface IAMClient > mocks/grpc-interfaces/github.com/kloudlite/api/rpc/iam/iam-client.go
      #
      # - mkdir -p mocks/grpc-interfaces/github.com/kloudlite/api/rpc/accounts
      # - mocki --package github.com/kloudlite/api/grpc-interfaces/github.com/kloudlite/api/rpc/accounts --interface AccountsClient > mocks/grpc-interfaces/github.com/kloudlite/api/rpc/accounts/accounts-client.go
      #
      # - mkdir -p mocks/grpc-interfaces/github.com/kloudlite/api/rpc/message-office-internal
      #
      # # pkg/kafka mocks
      # - mkdir -p mocks/pkg/kafka
      # - mocki --package github.com/kloudlite/api/pkg/kafka --interface Producer > mocks/pkg/kafka/producer.go
      # - mocki --package github.com/kloudlite/api/pkg/kafka --interface Consumer > mocks/pkg/kafka/consumer.go
