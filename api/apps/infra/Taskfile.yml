version: '3'

tasks:
  build:
    cmds:
      - go build main.go
  run:
    env:
      GRPC_PORT: 50051
      SSH_KEYS_PATH: "{{.HOME}}/tmp/kloudlite/keys"
      DATA_PATH: "{{.HOME}}/tmp/kloudlite/data"
      CONFIG_DATA_PATH: "{{.HOME}}/tmp/kloudlite/config"
      KAFKA_BOOTSTRAP_SERVERS: dev-kafka-headless.hotspot.svc.cluster.local:9092
      KAFKA_INFRA_TOPIC: dev-hotspot-infra
      KAFKA_INFRA_RESP_TOPIC: dev-hotspot-infra-resp
      KAFKA_GROUP_ID: infra-cli
      DO_API_KEY: ***REMOVED***
      DO_IMAGE_ID: 107782054
      NODE_DRAIN_TIME: 120
    cmds:
      - go run -tags dynamic main.go

  docker-build:
    dir: ../..
    vars:
      IMAGE: harbor.dev.madhouselabs.io/kloudlite/infra:v2
      APP_DIR: ./apps/infra
    cmds:
      - docker build -f ./{{.APP_DIR}}/Dockerfile -t {{.IMAGE}} . --build-arg APP_DIR={{.APP_DIR}}
      - docker push {{.IMAGE}}
