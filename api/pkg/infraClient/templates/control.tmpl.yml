{{- $hostname := get . "hostname"}}

{{- $machineCert := get . "machine-cert"}}
{{- $machineKey := get . "machine-key"}}
{{- $machineToken := get . "machine-token"}}
{{- $machineType := get . "machine-type"}}

{{- $endpoint := get . "endpoint"}}
{{- $endpointIp := get . "endpoint-ip"}}

{{- $clusterName := get . "cluster-name"}}
{{- $clusterToken := get . "cluster-token"}}
{{- $clusterEncryptinSecret := get . "cluster-encryption-secret"}}
{{- $clusterId := get . "cluster-id"}}
{{- $clusterSecret := get . "cluster-secret"}}
{{- $clusterCert := get . "cluster-cert"}}
{{- $clusterKey := get . "cluster-key"}}
{{- $clusterACert := get . "cluster-aggregator-cert"}}
{{- $clusterAKey := get . "cluster-aggregator-key"}}
{{- $clusterServiceAccountKey := get . "cluster-service-account-key"}}

{{- $etcdCert := get . "etcd-cert"}}
{{- $etcdKey := get . "etcd-key"}}

version: v1alpha1
debug: false
persist: true
machine:
    type: {{$machineType}}
    token: {{$machineToken}}
    ca:
        crt: {{$machineCert}}
        key: {{$machineKey}}
    certSANs: []
    kubelet:
        image: ghcr.io/siderolabs/kubelet:v1.24.6
        defaultRuntimeSeccompProfileEnabled: true 
        
    network: 
      hostname: {{$hostname}}
      kubespan:
          enabled: true

    install:
        disk: /dev/sda
        image: ghcr.io/siderolabs/installer:v1.2.3
        bootloader: true
        wipe: false
        
    registries:
        mirrors:
            k8s.gcr.io:
                endpoints:
                    - https://registry.k8s.io
                    - https://k8s.gcr.io
        
    features:
        rbac: true 
        stableHostname: true

    udev:
        rules:
            - SUBSYSTEM=="drm", KERNEL=="renderD*", GROUP="44", MODE="0666"


        
cluster:
    id: {{$clusterId}}
    secret: {{$clusterSecret}}
    controlPlane:
        endpoint: "https://{{$endpoint}}:6443"
    clusterName: {{$clusterName}}
    network:
        dnsDomain: cluster.local
        podSubnets:
            - 10.244.0.0/16
        serviceSubnets:
            - 10.96.0.0/12
    token: {{$clusterToken}}
    aescbcEncryptionSecret: {{$clusterEncryptinSecret}}
    ca:
        crt: {{$clusterCert}} 
        key: {{$clusterKey}}
    aggregatorCA:
        crt: {{$clusterACert}}
        key: {{$clusterAKey}}
    serviceAccount:
        key: {{$clusterServiceAccountKey}} 
    apiServer:
        image: k8s.gcr.io/kube-apiserver:v1.24.6
        certSANs:
            - {{$endpoint}}
        disablePodSecurityPolicy: true
        admissionControl:
            - name: PodSecurity
              configuration:
                apiVersion: pod-security.admission.config.k8s.io/v1alpha1
                defaults:
                    audit: restricted
                    audit-version: latest
                    enforce: privileged
                    enforce-version: latest
                    warn: restricted
                    warn-version: latest
                exemptions:
                    namespaces:
                        - kube-system
                    runtimeClasses: []
                    usernames: []
                kind: PodSecurityConfiguration
    controllerManager:
        image: k8s.gcr.io/kube-controller-manager:v1.24.6
    proxy:
        image: k8s.gcr.io/kube-proxy:v1.24.6
        
    scheduler:
        image: k8s.gcr.io/kube-scheduler:v1.24.6
    discovery:
        enabled: true
        registries:
            kubernetes:
                disabled: true
            service: {}
    etcd:
        ca:
            crt: {{$etcdCert}}
            key: {{$etcdKey}}
        
    extraManifests: []
    inlineManifests: []
