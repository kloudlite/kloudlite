{{- $hostname := get . "hostname"}}

{{- $machineCert := get . "machine-cert"}}
{{- $machineType := get . "machine-type"}}
{{- $machineToken := get . "machine-token"}}

{{- $endpoint := get . "endpoint"}}

{{- $clusterId := get . "cluster-id"}}
{{- $clusterToken := get . "cluster-token"}}
{{- $clusterCert := get . "cluster-cert"}}
{{- $clusterSecret := get . "cluster-secret"}}
{{- $labels := get . "labels"}}

version: v1alpha1
debug: false
persist: true
machine:
    type: {{$machineType}}
    token: {{$machineToken}}
    ca:
        crt: {{$machineCert}}
        key: ""
    certSANs: []
    kubelet:
        extraArgs:
            node-labels: {{$labels}} 
        image: ghcr.io/siderolabs/kubelet:v1.24.6
        defaultRuntimeSeccompProfileEnabled: true
    network: 
      hostname: {{$hostname}}
      kubespan:
        enabled: true 
    install:
        disk: /dev/sda
        image: ghcr.io/siderolabs/installer:v1.2.3
        bootloader: true
        wipe: false 
    registries:
        mirrors:
            k8s.gcr.io:
                endpoints:
                    - https://registry.k8s.io
                    - https://k8s.gcr.io
    features:
        rbac: true
        stableHostname: true

    udev:
        rules:
            - SUBSYSTEM=="drm", KERNEL=="renderD*", GROUP="44", MODE="0666"



cluster:
    id: {{$clusterId}}
    secret: {{$clusterSecret}}
    controlPlane:
        endpoint: "https://{{$endpoint}}:6443"
    network:
        dnsDomain: cluster.local
        podSubnets:
            - 10.244.0.0/16
        serviceSubnets:
            - 10.96.0.0/12

        
    token: {{$clusterToken}}
    aescbcEncryptionSecret: ""
    ca:
        crt: {{$clusterCert}} 
        key: ""
    discovery:
        enabled: true
        registries:
            kubernetes:
                disabled: true
            service: {}
