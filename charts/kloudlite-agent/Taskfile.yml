version: 3

vars:
  HelmChart: "."
  HelmValuesFile: "./values.yaml"
  HelmValuesTemplateFile: "./values.yml.tpl"

  ReleaseName: 'kloudlite-agent'
  ReleaseNamespace: 'kl-init-operators'

includes:
  cmd:
    taskfile: ../../Taskfile.yml
    internal: true
    dir:  ../..

tasks:
  compile:
    vars:
      Required: '⚠️  **Required**'
      ImagePrefix: "ghcr.io/kloudlite"
      ImageVersionTag: "v1.0.5-nightly"
    env:
      Required: "{{.Required}}"

      AccountName: "''"
      ClusterName: "''"

      ClusterToken: "''"
      AccessToken: "''"

      ClusterIdentitySecretName: 'kl-cluster-identity'

      SvcAccountName: "sa"

      MessageOfficeGRPCAddr: ""

      ImageAgent: "{{.ImagePrefix}}/agents/kl-agent:{{.ImageVersionTag}}"
      ImageOperatorResourceWatcher: "{{.ImagePrefix}}/agents/resource-watcher:{{.ImageVersionTag}}"

      # ImageWgOperator: "{{.ImagePrefix}}/agent/operator/wg:{{.ImageVersionTag}}"
      ImageWgOperator: "{{.ImagePrefix}}/operators/wireguard:{{.ImageVersionTag}}"

      WgPodCIDR: '10.42.0.0/16'
      WgSvcCIDR: '10.43.0.0/16'
      WgDnsHostedZone: ""

      EnableWgExamples: false
      PrefersOperatorsOnMasterNodes: true
    cmds:
      - task: cmd:setup
      - |+
        if [ -f {{.HelmValuesFile}} ]; then 
          chmod 600 {{.HelmValuesFile}}
        fi
      - echo "### DO NOT EDIT, generated by 'task compile', use 'values.yml.tpl' file to update" > {{.HelmValuesFile}}
      - |+
        {{.TMPL}} parse -f {{.HelmValuesTemplateFile}} --missing-key=error >> {{.HelmValuesFile}} - chmod 400 {{.HelmValuesFile}}

  debug:
    cmds:
      - task: compile
      - helm install --dry-run --debug {{.ReleaseName}} --namespace {{.ReleaseNamespace}} --create-namespace {{.HelmChart}} -f {{.HelmValuesFile}} | {{.SCHELM}} -f /tmp/manifests
      - tree /tmp/manifests

  install:
    cmds: 
      - task: compile
      - helm upgrade --install {{.ReleaseName}} --namespace {{.ReleaseNamespace}} --create-namespace {{.HelmChart}} -f {{.HelmValuesFile}}

  uninstall:
    cmds: 
      - helm uninstall {{.ReleaseName}} --namespace {{.ReleaseNamespace}}

