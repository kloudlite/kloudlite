version: 3

vars:
  HelmChart: "."
  ValuesYamlFile: "./values.yaml"

  ReleaseName: 'kloudlite-operators'
  ReleaseNamespace: 'kl-init-operators'

tasks:
  compile:
    env:
      EnvName: development
      ImageTag: v1.0.5

      AccountName: "<account-name>"
      Region: "<region>"

      ClusterName: "<cluster-name>"
      ClusterToken: "<cluster-token>"
      ClusterIdentitySecretName: 'kl-cluster-identity'

      ClusterSvcAccount: kloudlite-cluster-svc-account

      MessageOfficeGRPCAddr: message-office-api.dev.kloudlite.io:443
      DockerConfigJson: '<docker-config-json>'

      # KafkaBrokers: ***REMOVED***
      # KafkaSASLUsername: admin
      # KafkaSASLPassword: '***REMOVED***'

      DnsApiEndpoint: 'https://dns-api.kloudlite.io'
      DnsApiBasicAuthUsername: <dns-api-basic-auth-username>
      DnsApiBasicAuthPassword: <dns-api-basic-auth-password>

      WgDomain: 'wg.khost.dev'
      WgPodCIDR: '10.42.0.0/16'
      WgSvcCIDR: '10.43.0.0/16'

      ImageRegistryHost: "<harbor-image-registry-host>"

    cmds:
      - |+
        if [ -f ./values.generated.yaml ]; then 
          chmod 600 ./values.generated.yaml
        fi
      - echo "### DO NOT EDIT, generated by 'task compile', use 'values.yml.tpl' file to update" > {{.ValuesYamlFile}}
      - nxt template parse -f values.yml.tpl --missing-key=error' >> {{.ValuesYamlFile}}
      - chmod 400 {{.ValuesYamlFile}}

  debug:
    cmds:
      - task: compile
      - helm install --dry-run --debug {{.ReleaseName}} --namespace {{.ReleaseNamespace}} --create-namespace . -f {{.ValuesYamlFile}} | schelm -f /tmp/manifests
      - tree /tmp/manifests

  install:
    cmds: 
      - task: kl-dev:compile
      - helm upgrade --install {{.ReleaseName}} --namespace {{.ReleaseNamespace}} --create-namespace . -f {{.ValuesYamlFile}}

  copy-crds:
    cmds: 
      - |+
        pushd ../../operator
        make manifests
        popd
        mkdir -p ./templates/crds/operator
        cp ../../operator/config/crd/bases/* ./templates/crds/operator

      - |+
        pushd ../../wg-operator
        make manifests
        popd
        mkdir -p ./templates/crds/wg-operator
        cp ../../wg-operator/config/crd/bases/* ./templates/crds/wg-operator

      - |+
        pushd ../../cluster-operator
        make manifests
        popd
        mkdir -p ./templates/crds/cluster-operator
        cp ../../cluster-operator/config/crd/bases/* ./templates/crds/cluster-operator
