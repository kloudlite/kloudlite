version: 3

dotenv:
  - .secrets/env

vars:
  ImagePrefix: ghcr.io/kloudlite/infrastructure-as-code

tasks:
  local-build:
    preconditions:
      - sh: '[[ -n "{{.Image}}" ]]'
        msg: 'var Image must have a value'
    silent: true
    cmds:
      - nerdctl build -t {{.Image}} .

  container:build-and-push:
    preconditions:
      - sh: '[[ -n "{{.Image}}" ]]'
        msg: 'var Image must have a value'
    vars:
      Push: true
      DockerArgs: ""
    cmds:
      - docker build -t {{.Image}} . {{.DockerArgs}}
      - |+
        if [ "{{.Push}}" == "true" ]; then
          docker push {{.Image}}
        fi

  tf:download:kubeconfig:dev:
    vars:
      AuthToken: "{{.TF_TOKEN_app_terraform_io}}"
      WorkspaceId: "{{.TF_CLOUD_DEV_WORKSPACE_ID}}"
    cmds:
      - |+
        curl --silent -H "Authorization: Bearer {{.AuthToken}}" 'https://app.terraform.io/api/v2/workspaces/{{.WorkspaceId}}/current-state-version?include=outputs' | jq '.included[] | select(.attributes.name == "kubeconfig") | .attributes.value' -r | base64 -d
