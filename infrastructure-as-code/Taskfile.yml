version: 3

dotenv:
  - .secrets/env

vars:
  ImagePrefix: ghcr.io/kloudlite/infrastructure-as-code

tasks:
  docker-build:
    vars:
      Image: "{{.ImagePrefix}}:{{.Tag}}"
    preconditions:
      - sh: '[[ -n "{{.Tag}}" ]]'
        msg: 'var Tag must have a value'
    silent: true
    cmds:
      - docker build -t {{.Image}} .
      - docker push {{.Image}}
      # - podman buildx build -t {{.Image}} .
      # - podman push {{.Image}}

  tf:download:kubeconfig:dev:
    vars:
      AuthToken: "{{.TF_TOKEN_app_terraform_io}}"
      # WorkspaceId: "${TF_CLOUD_DEV_WORKSPACE_ID}"
      WorkspaceId: "{{.TF_CLOUD_DEV_WORKSPACE_ID}}"
    cmds:
      - |+
        curl --silent -H "Authorization: Bearer {{.AuthToken}}" 'https://app.terraform.io/api/v2/workspaces/{{.WorkspaceId}}/current-state-version?include=outputs' | jq '.included[] | select(.attributes.name == "kubeconfig") | .attributes.value' -r | base64 -d
