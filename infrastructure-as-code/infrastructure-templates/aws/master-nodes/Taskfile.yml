version: 3

tasks:
  create-diff-patch:
    vars:
      bundleName:
        sh: ls ../../terraform/bundles | fzf
    cmds:
      - |+
        diff -u ../../terraform/bundles/{{.bundleName}}/variables.tf ./variables-{{.bundleName}}.tf > ./variables-{{.bundleName}}.tf.diff.patch
        exit 0

  sync-variables:
    vars:
      bundlePath: "../../../terraform/bundles/aws/master-nodes"
      banner: |+
        /*
        DO NOT EDIT THIS FILE DIRECTLY. IT WILL BE OVERWRITTEN.
        If you need to change any variable, please edit the corresponding variables in the {{.bundlePath}} directory.
        If you want to create new variables, please create them in other files
        */
    cmds:
      - |+ #sh
        bundlePath="{{.bundlePath}}"
        bundleName=$(basename "$bundlePath")
        if [ -f "./variables-$bundleName.tf" ]; then
          chmod 600 "./variables-$bundleName.tf"
        fi

        [ -d "$bundlePath" ] || (echo "bundle path does not exist" && exit 1)
        
        cat > "./variables-$bundleName.tf" <<EOF
        {{.banner}}
        EOF
        
        cat $bundlePath/variables.tf >> ./variables-$bundleName.tf
        chmod 400 "./variables-$bundleName.tf"
