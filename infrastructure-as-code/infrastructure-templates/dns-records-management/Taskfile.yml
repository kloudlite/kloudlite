version: 3

tasks:
  create-diff-patch:
    vars:
      bundleName:
        sh: ls ../../terraform/bundles | fzf
    cmds:
      - |+
        diff -u ../../terraform/bundles/{{.bundleName}}/variables.tf ./variables-{{.bundleName}}.tf > ./variables-{{.bundleName}}.tf.diff.patch
        exit 0

  sync-variables:
    vars:
      banner: |+
        /*
        DO NOT EDIT THIS FILE DIRECTLY. IT WILL BE OVERWRITTEN.
        If you need to change any variable, please edit the corresponding variables in the terraform/bundles directory.
        If you want to create new variables, please create them in other files
        */
    env:
      moduleName: "cloudflare-dns"
      modulePath: "../../terraform/modules/cloudflare/dns"
    cmds:
      - |+
        newVarsfile="./variable-$moduleName.tf"
        if [ -f "$newVarsfile" ]; then
          chmod 600 "$newVarsfile"
        fi
        
        patchFile="./${newVarsfile}.diff.patch"
        if [ -f "$patchFile" ]; then
          patch $modulePath/variables.tf  < ./${newVarsfile}.diff.patch --output=- > ./${newVarsfile}
        else 
          cat > "$newVarsfile" <<EOF
        {{.banner}}
        EOF
        
        cat $modulePath/variables.tf >> ./${newVarsfile}
        chmod 400 "${newVarsfile}"
        fi
