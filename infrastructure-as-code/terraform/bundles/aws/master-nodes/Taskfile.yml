version: 3

vars:
  Varsfile: ".secrets/varfile.json"

dotenv:
  - .secrets/env

tasks:
  create-diff-patch:
    vars:
      bundleName:
        sh: ls ../../terraform/bundles | fzf
    cmds:
      - |+
        diff -u ../../terraform/bundles/{{.bundleName}}/variables.tf ./variables-{{.bundleName}}.tf > ./variables-{{.bundleName}}.tf.diff.patch
        exit 0

  sync-vars-from-dependencies:
    env:
      dependencies: "../kloudlite-k3s-masters"
    cmds:
      - |+
        for i in ${dependencies}; do
          result=./$(basename $i)-variables.tf
          [ -f $result ] &&  chmod 600 $result
          echo "// DO NOT EDIT THIS FILE. IT WILL BE COPIED FROM $i/variables.tf" > $result
          cat $i/variables.tf >> $result
          chmod 400 $result
        
          if [ -d "$bundlePath" ]; then
            patchFile="./variables-$bundleName.tf.diff.patch"
            if [ -f "$patchFile" ]; then
              patch $bundlePath/variables.tf  < ./variables-$bundleName.tf.diff.patch --output=- > ./variables-$bundleName.tf
            else 
              cat > "./variables-$bundleName.tf" <<EOF
        {{.banner}}
        EOF
              cat $bundlePath/variables.tf >> ./variables-$bundleName.tf
            fi
            chmod 400 "./variables-$bundleName.tf"
          fi
        done
        # chmod 600 ./*.tf
        # cp {{.InfrastructureTemplate}}/*.tf ./
        # chmod 400 ./*.tf
