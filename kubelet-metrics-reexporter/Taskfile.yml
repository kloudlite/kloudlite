version: 3

tasks:
  build:
    env:
      GOOS: linux
      GOARCH: amd64
      CGO_ENABLED: 0
    cmds:
      - go build -o ./bin/kubelet-metrics-reexporter .
  dev:
    preconditions:
      - sh: '[ ! -z "{{.NodeName}}" ]'
        msg: 'var NodeName must be defined'
    cmds:
      - fwatcher --ext '.go' --exec '
          go run main.go --dev 
                --node-name {{.NodeName}} 
                --enrich-from-annotations 
                --filter-prefix "kloudlite.io/observability"
                --replace-prefix "kloudlite.io/observability.tracking.id/=kl_tracking_id"
          ' 

  test:
    cmds:
      - fwatcher --ext '.go' --exec 'go test ./internal/parser/...'

  coverage:
    cmds:
      - go-test-cover.sh ./internal/parser/...

  docker:build-n-push:
    preconditions:
      - sh: '[ -n "{{.Tag}}" ]'
        msg: "env var Tag must be provided"
    vars:
      Image: "ghcr.io/nxtcoder17/kubelet-metrics-reexporter:{{.Tag}}"
    cmds:
      - task: build
      - docker build -t {{.Image}} .
      - docker push {{.Image}}
