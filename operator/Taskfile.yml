version: '3'

dotenv: [".secrets/env"]
tasks:
  dev:
    cmds:
      - task: kill-port
      - go run -tags dynamic main.go |& pp -rel-path
  run:
    run: always
    deps:
      # - pre
    cmds:
      - task: kill-port
      - nodemon -w '**/*.go' -q -e go --signal SIGKILL --exec 'go run -tags dynamic main.go |& pp -rel-path || exit 1'
      # - nodemon -w '**/*.go' -q -e go --signal SIGKILL --exec 'task dev'
      # - go run -tags musl main.go
    sources:
      - ./**/*.go
    method: timestamp
  new-mres-kind:
    cmds:
      # - operator-sdk create api --group mres --version v1 --resource --controller --kind {{.CLI_ARGS}}
      - operator-sdk create api --group mres --version v1 --resource --controller --kind "{{.CLI_ARGS}}"

  mongo-operator:
    cmds:
      - operator-sdk create api --plugins=helm --group crds --version v1 --kind MongoDB --helm-chart mongodb --helm-chart-repo https://charts.bitnami.com/bitnami
  helm-ops:
    dir: ./helm/
    cmds:
      - operator-sdk init --plugins helm --domain kloudlite.io --group crds --version v1 --kind MongoDBHelm --helm-chart-repo https://charts.bitnami.com/bitnami --helm-chart mongodb
  helm-ops-mongo:
    dir: ./helm/
    cmds:
      - operator-sdk create api --plugins helm --helm-chart-repo https://charts.bitnami.com/bitnami --helm-chart mongodb
  helm-ops-run:
    dir: ./helm
    cmds:
      - make install run
  helm-ops-clean:
    cmds:
      - rm -rf ./helm
  pre:
    run: once
    cmds:
      - make manifests
      - make generate
      - task: apply

  apply:
    run: once
    dir: config/crd/bases
    cmds:
      - kubectl apply -f .
  
  kill-port:
    run: always
    cmds:
      - |
        PID=$(lsof -t -i:8089)
        echo "$PID"
        if [ "$PID" != "" ]; then
          kill -9 $PID
        fi
    silent: true


