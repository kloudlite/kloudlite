version: '3'

dotenv: [".secrets/env"]

includes:
  helm:
    taskfile: ./helm/Taskfile.yml
    dir: ./helm/

tasks:
  new-kind:
    silent: true
    cmds:
      - | 
        [ -z "{{.Group}}" ] && echo env-var 'Group' not provided && exit 1
        [ -z "{{.Kind}}" ] && echo env-var 'Kind' not provided && exit 1
        exit 0
      - operator-sdk create api --group {{.Group}} --version v1 --resource --controller --kind "{{.Kind}}"

  run:
    run: always
    cmds:
      - task: kill-port
#      - go run -tags dynamic main.go -dev |& pp -rel-path
      - go build -i -tags dynamic -o ./bin/operator
      - ./bin/operator |& pp -rel-path
#      - go run -tags dynamic main.go |& pp -rel-path
#      - nodemon -w '**/*.go' -q -e go --signal SIGKILL --exec 'go run -tags dynamic main.go'
#      - nodemon -w '**/*.go' -q -e go --signal SIGKILL --exec 'go run -tags dynamic main.go'
    sources:
      - ./**/*.go
    method: timestamp

  build:
    cmds:
      - operator-sdk build harbor.dev.madhouselabs.io/kloudlite/operator:latest

  deploy:
    env:
      IMG: harbor.dev.madhouselabs.io/kloudlite/koperator:latest
      NAMESPACE: koperator
    cmds:
      - make docker-build docker-push
      - cd config/manager && kustomize edit set image controller=${IMG} && kustomize edit set namespace ${NAMESPACE}
      - cd config/default && kustomize edit set namespace ${NAMESPACE}
      - make deploy

  helm-operators:
    dir: ./helm
    cmds:
      - echo "this is to create new helm operators/kind"
#      - operator-sdk create api --plugins=helm --group msvc --version v1 --kind HelmMongoDB --helm-chart mongodb --helm-chart-repo https://charts.bitnami.com/bitnami
#      - operator-sdk create api --plugins=helm --group msvc --version v1 --kind HelmMySqlDB --helm-chart mysql --helm-chart-repo https://charts.bitnami.com/bitnami
#      - operator-sdk create api --plugins=helm --group msvc --version v1 --kind HelmElasticSearch --helm-chart elasticsearch --helm-chart-repo https://charts.bitnami.com/bitnami
      - operator-sdk create api --plugins=helm --group msvc --version v1 --kind HelmRedis --helm-chart redis --helm-chart-repo https://charts.bitnami.com/bitnami
  pre:
    run: once
    cmds:
      - go mod tidy
      - make manifests
      - make generate
      - task: apply

  apply:
    run: once
    dir: config/crd/bases
    cmds:
      - kubectl apply -f .

  kill-port:
    run: always
    cmds:
      - |
        PID=$(lsof -t -i:8089)
        echo "$PID"
        if [ "$PID" != "" ]; then
          kill -9 $PID
        fi
    silent: true


