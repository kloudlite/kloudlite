version: 3

dotenv: [".secrets/env"]

vars:
  dockerRegistry: "harbor.dev.madhouselabs.io"

tasks:
  new-kind:
    summary: |+
      [example usage]
      task new-kind Group=sample.kloudlite.io Kind=SampleKind
#

    silent: true
    preconditions:
      - sh: '[ -n "{{.Group}}" ]'
        msg: 'var Group must have a value'
      - sh: '[ -n "{{.Kind}}" ]'
        msg: 'var Kind must have a value'

    cmds:
      - operator-sdk create api --group {{.Group}} --version v1 --resource --controller=false --kind "{{.Kind}}"

  setup:
    dir: ./bin
    cmds:
      - curl -L0 https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv4.5.5/kustomize_v4.5.5_linux_amd64.tar.gz > kustomize.tar.gz
      - tar xf kustomize.tar.gz && rm -rf kustomize.tar.gz

  yaml:crds:
    cmds:
      - make manifests
      - cat config/crd/bases/*.yaml | yq -y

  yaml:operator:
    summary: |+
      env `ENV_NAME`, `IMAGE_TAG` need to be injected from shell while apply these yamls

      ###
      .securityContext.capabilities.drop=["ALL"] |
      .securityContext.seccompProfile.type = "RuntimeDefault" |
#

    preconditions:
      - sh: '[ -n "{{.Name}}" ]'
        msg: 'env Name must be set'

    silent: true
    vars:
      Image: "{{.dockerRegistry}}/kloudlite/operators/${ENV_NAME}/{{.Name}}:${IMAGE_TAG}"
      Namespace: kl-init-operators
      SvcAccountName: kloudlite-cluster-svc-account
      ImagePullPolicy: $IMAGE_PULL_POLICY
    cmds:
      - |+
        export PATH="$PWD/bin:$PATH"

        kustomize build config/default | yq '
          select(.kind == "Deployment") |
          .metadata.name = "kl-{{.Name}}-operator" |
          .metadata.namespace = "{{.Namespace}}" |
          .metadata.labels."control-plane" = "{{.Name}}" |
          .spec.selector.matchLabels."control-plane" = "{{.Name}}" |
          .spec.template.metadata.labels."control-plane" = "{{.Name}}" |
          .spec.template.spec.serviceAccountName = "{{.SvcAccountName}}" |
          .spec.template.spec.containers = (
            .spec.template.spec.containers | map_values(
              if .name == "manager" then
                .image = "{{.Image}}" |
                .imagePullPolicy = "{{.ImagePullPolicy}}" |
                .resources.limits = {} |
                .resources.limits.memory = "200Mi" |
                .resources.requests.cpu = "64m" |
                .resources.requests.memory = "96Mi" |
                .securityContext.allowPrivilegeEscalation = false
              elif .name == "kube-rbac-proxy" then
                .resources.limits = {} |
                .resources.requests.cpu = "5m" |
                .resources.requests.memory = "10Mi" |
                .securityContext.allowPrivilegeEscalation = false
              else . end
            )
          )
        ' -y
#

  yaml:operators:
    silent: true
    cmds:
      - |+
        for dir in $(ls ./operators)
        do
          #  task yaml:operator Name="$dir" > .release/deployables/$dir.yml
          echo "---"
          task yaml:operator Name="$dir"
        done
#

  build:operator:
    preconditions:
      - sh: '[ -n "{{.Name}}" ]'
        msg: "var Name must have a value"
      - sh: '[ -d "./operators/{{.Name}}" ]'
        msg: 'directory operators/{{.Name}} must exist'
      - sh: '[ -n "{{.EnvName}}" ]'
        msg: 'var EnvName must have a value'
      - sh: '[ -n "{{.Tag}}" ]'
        msg: 'var Tag must have a value'
    vars:
      Image: "{{.dockerRegistry}}/kloudlite/operators/{{.EnvName}}/{{.Name}}:{{.Tag}}"
    silent: true
    cmds:
      - |+
        pushd "./operators/{{.Name}}" 1> /dev/null
        docker buildx build -t {{.Image}} . --build-context project="../.." --build-arg name="{{.Name}}"
        docker push {{.Image}}
        popd 1> /dev/null
#

  pre:
    run: once
    cmds:
      - go mod tidy
      - make manifests
      - make generate
      - kubectl apply -f config/crd/bases

  new:operator:
    preconditions:
      - sh: test -n '{{.name}}'
        msg: "var name must have a value"
      - sh: test ! -d './operators/{{.name}}'
        msg: 'directory ./operators/{{.name}} must not exist'
    cmds:
      - mkdir -p ./operators/{{.name}}

  new:controller:
    summary: |+
      example:
        task new:controller -- --api-group mongodb.msvc.kloudlite.io --debug --kind Database --kind-plural databases --package database --kind-pkg mongodbMsvcv1
      {{.KLOP}} controller create --api-group crds.kloudlite.io --kind Project --kind-pkg crdsv1 --kind-plural projects --package controllers --debug
#

    silent: true
    vars:
      KLOP:
        sh: echo $PWD/bin/klop
    cmds:
      - eval {{.KLOP}} controller create {{.CLI_ARGS}}

  new:msvc-controller:
    summary: |+
      example:
        task new:msvc-controller -- --api-group mongodb.msvc.kloudlite.io --debug --kind Database --kind-plural databases --package database --kind-pkg mongodbMsvcv1
      {{.KLOP}} msvc-controller create --api-group crds.kloudlite.io --kind Project --kind-pkg crdsv1 --kind-plural projects --package controllers --debug
#

    silent: true
    vars:
      KLOP:
        sh: echo $PWD/bin/klop
    cmds:
      - eval {{.KLOP}} msvc-controller create {{.CLI_ARGS}}

  new:mres-controller:
    summary: |+
      example:
        task new:msvc-controller -- --api-group mongodb.msvc.kloudlite.io --debug --kind Database --kind-plural databases --package database --kind-pkg mongodbMsvcv1
      {{.KLOP}} msvc-controller create --api-group crds.kloudlite.io --kind Project --kind-pkg crdsv1 --kind-plural projects --package controllers --debug
#

    silent: true
    vars:
      KLOP:
        sh: echo $PWD/bin/klop

    cmds:
      - eval {{.KLOP}} mres-controller create {{.CLI_ARGS}}

  install:cmd:
    cmds:
      - go build -o ./bin/klop ./cmd/main.go

  build:webhook-worker:
    preconditions:
      - sh: '[ -n "{{.EnvName}}" ]'
        msg: 'var EnvName must have a value'
      - sh: '[ -n "{{.Tag}}" ]'
        msg: 'var Tag must have a value'
    vars:
      Name: webhook-worker
      Image: "{{.dockerRegistry}}/kloudlite/workers/{{.EnvName}}/registry-webhook-worker:{{.Tag}}"
    dir: ./webhook-worker
    cmds:
      - docker buildx build -t {{.Image}} . --build-context project=".." --build-arg name="{{.Name}}"
      - docker push {{.Image}}
