version: 3

# dotenv: [".secrets/env"]

vars:
#   dockerRegistry: "harbor.dev.madhouselabs.io"
  dockerRegistry: registry.kloudlite.io
  KlControllerGen: "./bin/kl-controller-gen"
  KlTemplatizer: "./bin/kl-templatizer"

tasks:
  new-kind:
    summary: |+
      [example usage]
      task new-kind Group=sample.kloudlite.io Kind=SampleKind
#

    silent: true
    preconditions:
      - sh: '[ -n "{{.Group}}" ]'
        msg: 'var Group must have a value'
      - sh: '[ -n "{{.Kind}}" ]'
        msg: 'var Kind must have a value'

    cmds:
      - operator-sdk create api --group {{.Group}} --version v1 --resource --controller=false --kind "{{.Kind}}"

  setup:
    dir: ./bin
    cmds:
      - curl -L0 https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv4.5.5/kustomize_v4.5.5_linux_amd64.tar.gz > kustomize.tar.gz
      - tar xf kustomize.tar.gz && rm -rf kustomize.tar.gz

  yaml:crds:
    cmds:
      - make manifests
      - |+
        [ -f config/crd/bases/_.yaml ] && rm config/crd/bases/_.yaml
      - |+
        for file in $(ls config/crd/bases/*.yaml)
        do
          cat $file
          echo "---"
        done

#

  yaml:operator:
    summary: |+
      env `ENV_NAME`, `IMAGE_TAG` need to be injected from shell while apply these yamls

      ###
      .securityContext.capabilities.drop=["ALL"] |
      .securityContext.seccompProfile.type = "RuntimeDefault" |
#

    preconditions:
      - sh: '[ -n "{{.Name}}" ]'
        msg: 'env Name must be set'

#     silent: true
    vars:
      Image: "{{.dockerRegistry}}/kloudlite/operators/${ENV_NAME}/{{.Name}}:${IMAGE_TAG}"
      Namespace: kl-init-operators
      SvcAccountName: kloudlite-cluster-svc-account
      ImagePullPolicy: $IMAGE_PULL_POLICY
      OverrideFile: "./operators/{{.Name}}/overrides.yml"
    env:
      Name: "{{.Name}}"
      Namespace: "{{.Namespace}}"
      SvcAccountName: kloudlite-cluster-svc-account
      Image: "{{.Image}}"
      ImagePullPolicy: "${IMAGE_PULL_POLICY}"
    cmds:
      - |+
        setArgs=""
        [ -f "{{.OverrideFile}}" ] && {
           setArgs=$(cat "{{.OverrideFile}}" | yq -r 'to_entries|map("--set \(.key)=###\(.value)###") | join(" ")' | sed "s/###/'/g" )
        }
        eval {{.KlTemplatizer}} < ./operators/deployment.yml.tpl $setArgs
#       - |+
#         export PATH="$PWD/bin:$PATH"
#
#         kustomize build config/default | yq '
#           select(.kind == "Deployment") |
#           .metadata.name = "kl-{{.Name}}-operator" |
#           .metadata.namespace = "{{.Namespace}}" |
#           .metadata.labels."control-plane" = "{{.Name}}" |
#           .spec.selector.matchLabels."control-plane" = "{{.Name}}" |
#           .spec.template.metadata.labels."control-plane" = "{{.Name}}" |
#           .spec.template.spec.serviceAccountName = "{{.SvcAccountName}}" |
#           .spec.template.spec.containers = (
#             .spec.template.spec.containers | map_values(
#               if .name == "manager" then
#                 .image = "{{.Image}}" |
#                 .imagePullPolicy = "{{.ImagePullPolicy}}" |
#                 .resources.limits = {} |
#                 .resources.limits.memory = "200Mi" |
#                 .resources.requests.cpu = "64m" |
#                 .resources.requests.memory = "96Mi" |
#                 .securityContext.allowPrivilegeEscalation = false
#               elif .name == "kube-rbac-proxy" then
#                 .resources.limits = {} |
#                 .resources.requests.cpu = "5m" |
#                 .resources.requests.memory = "10Mi" |
#                 .securityContext.allowPrivilegeEscalation = false
#               else . end
#             )
#           )
#         ' -y
#

  yaml:operators:
    silent: true
    cmds:
      - |+
        for dir in $(ls -d ./operators/*/)
        do
          [ "$dir" != "msvc-neo4j" ] && task yaml:operator Name="$(basename $dir)"
        done
#

  gobuild:operator:
    preconditions:
      - sh: '[ -n "{{.Name}}" ]'
        msg: "var Name must have a value"
      - sh: '[ -d "./operators/{{.Name}}" ]'
        msg: 'directory operators/{{.Name}} must exist'
    env:
      CGO_ENABLED: 0
      GOOS: linux
      GOARCH: amd64
    cmds:
      - |+
        pushd "./operators/{{.Name}}" 1> /dev/null
        go build -o /tmp/{{.Name}} ./main.go
        popd 1> /dev/null

#

  local-build:operator:
    preconditions:
      - sh: '[ -n "{{.Name}}" ]'
        msg: "var Name must have a value"
      - sh: '[ -d "./operators/{{.Name}}" ]'
        msg: 'directory operators/{{.Name}} must exist'
      - sh: '[ -n "{{.EnvName}}" ]'
        msg: 'var EnvName must have a value'
      - sh: '[ -n "{{.Tag}}" ]'
        msg: 'var Tag must have a value'
    vars:
      Image: "{{.dockerRegistry}}/kloudlite/operators/{{.EnvName}}/{{.Name}}:{{.Tag}}"
    env:
      CGO_ENABLED: 0
      GOOS: linux
      GOARCH: amd64
    silent: true
    cmds:
      - |+
        pushd "./operators/{{.Name}}" 1> /dev/null
        lineNumbers=$(cat Dockerfile | grep -i '^FROM' -n | tail +2 | awk -F: '{print $1}')

        startLineNo=$(echo "$lineNumbers" | head -n+1)
        finalLineNo=$(echo "$lineNumbers" | tail -1)

        tDir=$(mktemp -d)

        nDockerfile=$(cat Dockerfile | tail --lines=+$startLineNo | grep -i --invert-match 'from=builder')
        echo "$nDockerfile" | sed "1 i # syntax=docker/dockerfile:1.4" > $tDir/Dockerfile.base

        #lineNo=$(cat Dockerfile | grep -i '^FROM' -n | tail -1 | awk -F: '{print $1}')
        CGO_ENABLED=0 go build -o $tDir/{{.APP}} .

        cat $tDir/Dockerfile.base | sed "3 i COPY --from=local-builder ./{{.Name}} /manager" > $tDir/Dockerfile
        cat $tDir/Dockerfile

        docker buildx build -f $tDir/Dockerfile -t {{.Image}} . --build-context local-builder=${tDir}
        docker push {{.Image}}
        rm -rf $tDir
        popd 1> /dev/null


#

  build:operator:
    preconditions:
      - sh: '[ -n "{{.Name}}" ]'
        msg: "var Name must have a value"
      - sh: '[ -d "./operators/{{.Name}}" ]'
        msg: 'directory operators/{{.Name}} must exist'
      - sh: '[ -n "{{.EnvName}}" ]'
        msg: 'var EnvName must have a value'
      - sh: '[ -n "{{.Tag}}" ]'
        msg: 'var Tag must have a value'
    vars:
      Image: "{{.dockerRegistry}}/kloudlite/operators/{{.EnvName}}/{{.Name}}:{{.Tag}}"
    silent: true
    cmds:
      - |+
        pushd "./operators/{{.Name}}" 1> /dev/null
        docker buildx build -t {{.Image}} . --build-context project="../.." --build-arg name="{{.Name}}"
        docker push {{.Image}}
        popd 1> /dev/null
#

  pre:
    run: once
    cmds:
      - go mod tidy
      - make manifests
      - make generate
      - |+
        [ -f config/crd/bases/_.yaml ] && rm config/crd/bases/_.yaml
      - kubectl apply -f config/crd/bases

  new:operator:
    preconditions:
      - sh: test -n '{{.name}}'
        msg: "var name must have a value"
      - sh: test ! -d './operators/{{.name}}'
        msg: 'directory ./operators/{{.name}} must not exist'
    cmds:
      - mkdir -p ./operators/{{.name}}

  new:controller:
    summary: |+
      example:
        task new:controller -- --api-group mongodb.msvc.kloudlite.io --debug --kind Database --kind-plural databases --package database --kind-pkg mongodbMsvcv1
      {{.KLOP}} controller create --api-group crds.kloudlite.io --kind Project --kind-pkg crdsv1 --kind-plural projects --package controllers --debug
#

    silent: true
    vars:
      KLOP:
        sh: echo "$PWD/bin/{{.KlControllerGen}}"
    cmds:
      - eval {{.KlControllerGen}} controller create {{.CLI_ARGS}}

  new:msvc-controller:
    summary: |+
      example:
        task new:msvc-controller -- --api-group mongodb.msvc.kloudlite.io --debug --kind Database --kind-plural databases --package database --kind-pkg mongodbMsvcv1
      {{.KLOP}} msvc-controller create --api-group crds.kloudlite.io --kind Project --kind-pkg crdsv1 --kind-plural projects --package controllers --debug
#

    silent: true
    cmds:
      - eval {{.KlControllerGen}} msvc-controller create {{.CLI_ARGS}}

  new:mres-controller:
    summary: |+
      example:
        task new:msvc-controller -- --api-group mongodb.msvc.kloudlite.io --debug --kind Database --kind-plural databases --package database --kind-pkg mongodbMsvcv1
      {{.KLOP}} msvc-controller create --api-group crds.kloudlite.io --kind Project --kind-pkg crdsv1 --kind-plural projects --package controllers --debug
#

    silent: true
    cmds:
      - eval {{.KlControllerGen}} mres-controller create {{.CLI_ARGS}}

  install:cmd:
    cmds:
      - go build -o "{{.KlControllerGen}}" ./cmd/main.go

  install:templatizer:
    cmds:
      - go build -o "{{.KlTemplatizer}}" ./cmd/template/main.go

  build:agent:
    preconditions:
      - sh: '[ -n "{{.EnvName}}" ]'
        msg: 'var EnvName must have a value'
      - sh: '[ -n "{{.Tag}}" ]'
        msg: 'var Tag must have a value'
    vars:
      Name: kl-agent
      Image: "{{.dockerRegistry}}/kloudlite/{{.EnvName}}/{{.Name}}:{{.Tag}}"
    dir: ./agent
    cmds:
      - docker buildx build -t {{.Image}} . --build-context project=".." --build-arg name="{{.Name}}"
      - docker push {{.Image}}

  build:webhook-worker:
    preconditions:
      - sh: '[ -n "{{.EnvName}}" ]'
        msg: 'var EnvName must have a value'
      - sh: '[ -n "{{.Tag}}" ]'
        msg: 'var Tag must have a value'
    vars:
      Name: webhook-worker
      Image: "{{.dockerRegistry}}/kloudlite/workers/{{.EnvName}}/registry-webhook-worker:{{.Tag}}"
    dir: ./webhook-worker
    cmds:
      - docker buildx build -t {{.Image}} . --build-context project=".." --build-arg name="{{.Name}}"
      - docker push {{.Image}}

  build:http-lb:
    dir: ./http-lb
    preconditions:
      - sh: '[ -n "{{.EnvName}}" ]'
        msg: 'var EnvName must have a value'
      - sh: '[ -n "{{.Tag}}" ]'
        msg: 'var Tag must have a value'
    vars:
      Image: "{{.dockerRegistry}}/kloudlite/{{.EnvName}}/lb:{{.Tag}}"
    cmds:
      - docker buildx build -t {{.Image}} .
      - docker push {{.Image}}
