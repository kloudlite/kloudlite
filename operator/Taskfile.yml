version: '3'

dotenv: [".secrets/env"]
tasks:
  run:
    run: always
    deps:
      - pre
    cmds:
      - nodemon -w '**/*.go' -q -e go --signal SIGKILL --exec 'go run -tags dynamic main.go |& pp -rel-path || exit 1'
    sources:
      - ./**/*.go

  pre:
    run: once
    cmds:
      - make manifests
      - make generate
      - task: apply

  apply:
    run: once
    dir: config/crd/bases
    cmds:
      - kubectl apply -f .
