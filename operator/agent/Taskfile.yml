version: 3

env:
  SHELL: /bin/bash

tasks:
  run:
    env:
      KAFKA_BROKERS: "redpanda.kl-init-redpanda.svc.cluster.local:9092"
      KAFKA_CONSUMER_GROUP_ID: "kloudlite-operator"
      KAFKA_INCOMING_TOPIC: "kl-incoming"
      KAFKA_ERROR_ON_APPLY_TOPIC: "kl-error-on-apply"
    cmds:
      - go run ./main.go --dev

  docker-build:
    vars:
#       Image: harbor.dev.madhouselabs.io/kloudlite/{{.EnvName}}/kloudlite-agent
      Image: harbor.dev.madhouselabs.io/kloudlite/kloudlite-agent:{{.Tag}}
    preconditions:
      - sh: test -n '{{.Tag}}'
        msg: 'var Tag must have a value'
    cmds:
      - docker buildx build --build-context project=../ -t {{.Image}} .
      - docker push {{.Image}}
