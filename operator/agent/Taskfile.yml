version: 3

dotenv:
  - .secret/env

tasks:
  run:
    cmds:
      - go run ./main.go --dev

  docker-build:
    vars:
      # Image: harbor.dev.madhouselabs.io/kloudlite/{{.EnvName}}/kloudlite-agent
      Image: harbor.dev.madhouselabs.io/kloudlite/kloudlite-agent:{{.Tag}}
    preconditions:
      - sh: test -n '{{.Tag}}'
        msg: 'var Tag must have a value'
    cmds:
      - docker buildx build --build-context project=../ -t {{.Image}} .
      - docker push {{.Image}}
