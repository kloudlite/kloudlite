version: 3

env:
  SHELL: /bin/bash

tasks:
  run:
    env:
      KAFKA_BROKERS: "redpanda.kl-init-redpanda.svc.cluster.local:9092"
      KAFKA_CONSUMER_GROUP_ID: "kloudlite-operator"
      KAFKA_INCOMING_TOPIC: "kl-incoming"
      KAFKA_ERROR_ON_APPLY_TOPIC: "kl-error-on-apply"
    cmds:
      - go run ./main.go

  verify-vars:
    silent: true
    cmds:
      - |+
        [ -z "{{.Value}}" ] && echo "env-var {{.Name}} is required" && exit 1
        exit 0
      -

  build:
    vars:
      Image: harbor.dev.madhouselabs.io/kloudlite/{{.EnvName}}/kloudlite-agent
      Tag: latest
    cmds:
      - task: verify-vars
        vars:
          Name: EnvName
          Value: "{{.EnvName}}"
      - docker buildx build --build-context project=../ -t {{.Image}}:{{.Tag}} .
      - docker push {{.Image}}:{{.Tag}}
