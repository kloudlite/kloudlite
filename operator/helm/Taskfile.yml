version: 3

tasks:
  init:
    cmds:
      - operator-sdk init --plugins helm --domain kloudlite.io --group msvc --version v1 --kind MongoDB --helm-chart-repo https://charts.bitnami.com/bitnami --helm-chart mongodb

  new-kind:
    vars:
      Domain: kloudlite.io
      Group: msvc
    cmds:
      - operator-sdk create api --plugins helm --group {{.Group}} --version v1 --kind {{.Kind}} --helm-chart-repo {{.Repo}} --helm-chart {{.Chart}}

  deploy:
    env:
      IMG: harbor.dev.madhouselabs.io/kloudlite/koperator-helm:latest
      NAMESPACE: koperator
    cmds:
      - make docker-build docker-push
      - cd config/manager && kustomize edit set image controller=${IMG} && kustomize edit set namespace ${NAMESPACE}
      - cd config/default && kustomize edit set namespace ${NAMESPACE}
      - make deploy

  run:
    cmds:
      - make install
      - bin/helm-operator run --metrics-bind-address=":10017" --health-probe-bind-address=":10016"

  clean:
    cmds:
      - rm -rf ./helm-charts
