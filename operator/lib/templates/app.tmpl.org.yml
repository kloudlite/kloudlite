apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{.Name}}
  namespace: {{.Namespace}}
spec:
  selector:
    matchLabels:
      app: {{.Name}}
  template:
    metadata:
      labels:
        app: {{.Name}}
    spec:
    {{- if .Spec.Containers }}
      containers:
      {{- range $k, $v := .Spec.Containers }}
      {{- with $v }}
        name: {{.Name}}
        image: {{.Image}}
        imagePullPolicy: {{.ImagePullPolicy | default "Always"}}
        {{- if .Env}}
        env:
        {{- range .Env }}
        {{- with .}}
          - name: {{.Name}}
          {{- if .Value }}
            value: {{.Value}}
          {{- else }}
            valueFrom:
            {{- if eq .Type "config" }}
              configMapKeyRef:
                name: {{.RefName}}
                key: {{.RefKey}}
            {{- end }}
            {{- if eq .Type "secret" }}
              secretKeyRef:
                name: {{.RefName}}
                key: {{.RefKey}}
            {{- end }}
          {{- end}}
        {{- end }}
        {{- end }}
        {{- end }}
      {{- end }}
      {{- end }}
    {{- end }}
