{{- $obj := get . "object" }}
{{- $ownerRefs := get .  "owner-refs" }}
{{- $storageClass := get . "storage-class"}}

{{- $generatedVars := mustFromJson ($obj.Status.GeneratedVars |toJson) }}

{{- with $obj}}
{{- /* gotype: operators.kloudlite.io/apis/influxdb.msvc/v1.Service*/ -}}
apiVersion: msvc.kloudlite.io/v1
kind: HelmInfluxDB
metadata:
  name: {{.Name}}
  namespace: {{.Namespace}}
  ownerReferences:  {{ $ownerRefs | toYAML | nindent 4}}
spec:
  fullnameOverride: {{.Name}}
  auth:
    enabled: true
    admin:
      bucket: {{ .Spec.Admin.Bucket }}
      org: {{ .Spec.Admin.Org }}
      password: {{ index $generatedVars "admin-password" }}
      token: {{index $generatedVars "admin-token" }}
      username: {{ .Spec.Admin.Username }}

  {{- if .Labels }}
  commonLabels: {{.Labels | toYAML | nindent 4}}
  {{- end}}

  {{- if .Spec.NodeSelector}}
  nodeSelector: {{.Spec.NodeSelector | toYAML | nindent 4}}
  {{- end }}

  metrics:
    enabled: true

  volumePermissions:
    enabled: true

  persistence:
    accessModes:
      - ReadWriteOnce
    enabled: true
    size: {{.Spec.Storage.Size}}
    storageClass: {{$storageClass}}

  influxdb:
    resources:
      requests:
        memory: {{.Spec.Resources.Memory}}
      limits:
        cpu: {{.Spec.Resources.Cpu}}
        memory: {{.Spec.Resources.Memory}}
{{- end }}
