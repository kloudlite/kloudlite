apiVersion: msvc.kloudlite.io/v1
kind: HelmRedis
metadata:
  name: {{.Name}}
  namespace: {{.Namespace}}
#{{- if .Labels }}
#  labels:
#  {{- range $k, $v := .Labels }}
#    {{$k}}: {{$v}}
#  {{- end }}
#{{- end}}
  ownerReferences:
    - apiVersion: {{.APIVersion}}
      kind: {{.Kind}}
      name: {{.Name}}
      uid: {{.UID}}
      controller: true
      blockOwnerDeletion: true
spec:
#  global:
#    storageClass: do-block-storage

  fullnameOverride: {{.Name}}
  image:
    tag: 6.2.7-debian-10-r0

{{- if .Labels }}
  commonLabels:
  {{- range $k, $v := .Labels }}
    {{$k}}: {{$v}}
  {{- end }}
{{- end}}

  auth:
    enabled: true
    password: {{ index (mustFromJson (.Status.GeneratedVars | toJson)) "redis-password" }}

  replica:
    replicaCount: 0

  architecture: standalone

  commonConfiguration: |+
    {{- if .Spec.ACLAccounts}}
    {{- range $k, $v := .Spec.ACLAccounts}}
      {{ $v }}
    {{- end }}
    {{- end }}
      user auth-user on ~auth:* +@all -@dangerous +info resetpass >sample

  master:
    resources:
      requests:
        cpu: {{ index (mustFromJson (.Spec.Inputs | toJson)) "cpu_min" | default 400 }}m
        memory: {{ index (mustFromJson (.Spec.Inputs | toJson)) "memory_min" | default 400 }}Mi
      limits:
        cpu: {{ index (mustFromJson (.Spec.Inputs | toJson)) "cpu_max" |  default 400}}m
        memory: {{ index (mustFromJson (.Spec.Inputs | toJson)) "memory_max" | default 500}}Mi

  persistence:
    enabled: true
    size: {{ index (mustFromJson (.Spec.Inputs | toJson )) "size" | default "1Gi" }}

  volumePermissions:
    enabled: true

  metrics:
    enabled: false
