{{- $name := get . "name" }}
{{- $namespace := get . "namespace" }}

{{- $domains := get . "domains" }}
{{- $wildcardDomains := get . "wildcard-domains"}}


{{- $router := get . "router-ref"}}
{{- $routes := get . "routes" }}
{{- $ownerRefs := get . "owner-refs"}}
{{- $labels := get . "labels"}}
{{- $annotations := get . "annotations"}}
{{- $virtualHost := get . "virtual-hostname"}}

{{- $ingressClass := get . "ingress-class" }}
{{- $clusterIssuer := get . "cluster-issuer" }}

{{- $certIngressClass := get . "cert-ingress-class"  -}}
{{- $globalIngressClass := get . "global-ingress-class"  -}}


{{- with $router}}
{{- /*gotype: operators.kloudlite.io/apis/crds/v1.Router */ -}}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{$name}}
  namespace: {{$namespace}}
  annotations:
{{/*    {{ K8sAnnotation true "cert-manager.io/cluster-issuer" $clusterIssuer }}*/}}

    {{- $bodySize := printf "%dm" .Spec.MaxBodySizeInMB}}
    {{K8sAnnotation .Spec.MaxBodySizeInMB "nginx.ingress.kubernetes.io/proxy-body-size" $bodySize }}
    {{K8sAnnotation true "nginx.ingress.kubernetes.io/ssl-redirect" .Spec.Https.Enabled }}
    {{K8sAnnotation true "nginx.ingress.kubernetes.io/force-ssl-redirect" .Spec.Https.ForceRedirect }}

    {{- with .Spec.RateLimit}}
    {{- if .Enabled}}
    {{K8sAnnotation .Rps "nginx.ingress.kubernetes.io/limit-rps" .Rps }}
    {{K8sAnnotation .Rpm "nginx.ingress.kubernetes.io/limit-rpm" .Rpm }}
    {{K8sAnnotation .Connections "nginx.ingress.kubernetes.io/limit-connections" .Connections }}
    {{- end}}
    {{- end}}

    {{K8sAnnotation true "nginx.ingress.kubernetes.io/rewrite-target" "/$1" }}
    {{K8sAnnotation $virtualHost "nginx.ingress.kubernetes.io/upstream-vhost" $virtualHost}}

    {{- if $annotations}}
    {{ $annotations | toYAML | nindent 4}}
    {{- end}}
  labels: {{ $labels | toYAML | nindent 4}}
  ownerReferences: {{ $ownerRefs | toYAML| nindent 4}}
spec:
  ingressClassName: {{$ingressClass}}
  tls:
    {{- range $v := $domains }}
    - hosts:
        - {{$v | squote}}
      secretName: {{$v}}-tls
    {{- end}}
    {{- range $v := $wildcardDomains}}
    - hosts:
        - {{printf "*.%s" $v | squote}}
    {{- end}}
{{/*  tls:*/}}
{{/*    {{- range $v := .Spec.Domains }}*/}}
{{/*    - hosts:*/}}
{{/*        - {{$v}}*/}}
{{/*      secretName: {{$v}}-tls*/}}
{{/*    {{- end }}*/}}
{{/*    - hosts:*/}}
{{/*        - "*.{{$wildcardDomainSuffix}}"*/}}
  rules:
    {{- range $domain := .Spec.Domains }}
    - host: {{$domain}}
      http:
        paths:
          {{- range $route := $routes }}
          - backend:
              service:
                name: {{$route.App | default $route.Lambda}}
                port:
                  number: {{$route.Port}}

            {{- if $route.Rewrite }}
            path: {{$route.Path}}?(.*)
            {{- else}}
            {{ $x := len $route.Path }}
            path: /?{{if gt $x 1}}({{substr 1 $x $route.Path}}){{else}}(.*){{ end}}
            {{- end}}
            pathType: Prefix
          {{- end}}
    {{- end }}
  {{- end}}

---

{{/*ingress resource for getting cert*/}}
{{- with $router}}
{{- /*gotype: operators.kloudlite.io/apis/crds/v1.Router */ -}}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: cert-{{$name}}
  namespace: {{$namespace}}
  annotations:
    {{ K8sAnnotation true "cert-manager.io/cluster-issuer" $clusterIssuer }}
{{/*    {{K8sAnnotation true "nginx.ingress.kubernetes.io/ssl-redirect" .Spec.Https.Enabled }}*/}}
{{/*    {{K8sAnnotation true "nginx.ingress.kubernetes.io/force-ssl-redirect" .Spec.Https.ForceRedirect }}*/}}
    {{- if $annotations}}
    {{ $annotations | toYAML | nindent 4}}
    {{- end}}
  labels: {{ $labels | toYAML | nindent 4}}
  ownerReferences: {{ $ownerRefs | toYAML| nindent 4}}
spec:
  ingressClassName: {{$certIngressClass}}
  tls:
    {{- range $v := $domains }}
    - hosts:
        - {{$v | squote}}
      secretName: {{$v}}-tls
    {{- end }}
  rules:
    {{- range $domain := .Spec.Domains }}
    - host: {{$domain}}
      http:
        paths:
          - backend:
              service:
                name: sample
                port:
                  number: 80
            path: /_dummy
            pathType: Prefix
    {{- end }}
{{- end }}
