{{- $ownerRefs := get . "owner-refs"}}
{{- $storageClass := get . "storage-class" }}
{{- $obj := get . "object"}}

{{- $generatedVars := mustFromJson ($obj.Status.GeneratedVars | toJson) }}

{{- with $obj}}
{{- /* gotype: operators.kloudlite.io/apis/elasticsearch.msvc/v1.Service */ -}}
apiVersion: msvc.kloudlite.io/v1
kind: HelmElasticSearch
metadata:
  name: {{.Name}}
  namespace: {{.Namespace}}
  ownerReferences: {{ $ownerRefs | toYAML | nindent 4}}
  labels: {{.Labels | toYAML | nindent 4}}
spec:
  replicas: {{.Spec.ReplicaCount}}
  minimumMasterNodes: {{.Spec.ReplicaCount}}
  fullnameOverride: {{.Name}}

  {{- if .Spec.NodeSelector }}
  nodeSelector: {{.Spec.NodeSelector | toYAML | nindent 4}}
  {{- end }}

  volumeClaimTemplate:
    accessModes: [ "ReadWriteOnce" ]
    storageClassName: {{$storageClass}}
    resources:
      requests:
        storage: {{.Spec.Storage.Size}}

  resources:
    limits:
      cpu: {{.Spec.Resources.Cpu.Max}}
      memory: {{.Spec.Resources.Memory}}
    requests:
      cpu: {{.Spec.Resources.Cpu.Min}}
      memory: {{.Spec.Resources.Memory}}

  secret:
    enabled: true
    password: {{ index $generatedVars "password" }}

  service:
    enabled: true
{{- end}}
