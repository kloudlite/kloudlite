{{- $obj := get . "obj"}}
{{- $ownerRefs := get . "owner-refs"}}
{{- $storageClass := get . "storage-class" }}
{{- $elasticPassword := get . "elastic-password"  -}}

{{/*{{- $generatedVars := mustFromJson ($obj.Status.GeneratedVars | toJson) }}*/}}

{{- $elasticImageTag := "8.3.3-debian-11-r5" }}

{{- with $obj}}
{{- /* gotype: operators.kloudlite.io/apis/elasticsearch.msvc/v1.Service */ -}}
apiVersion: msvc.kloudlite.io/v1
kind: HelmElasticSearch
metadata:
  name: {{.Name}}
  namespace: {{.Namespace}}
  ownerReferences: {{ $ownerRefs | toYAML | nindent 4}}
  labels: {{.Labels | toYAML | nindent 4}}
spec:
  global:
    storageClass: {{$storageClass}}
    kibanaEnabled: false

  fullnameOverride: {{.Name}}

  {{- if .Labels }}
  commonLabels: {{ .Labels | toYAML | nindent 4}}
  {{- end}}

  image:
    tag: "{{$elasticImageTag}}"

  security:
    enabled: true
    tls:
      autoGenerated: true
    elasticPassword: {{$elasticPassword}}

  master:
    masterOnly: true
    replicaCount: {{.Spec.ReplicaCount}}
    resources:
      limits:
        cpu: {{.Spec.Resources.Cpu.Max}}
        memory: {{.Spec.Resources.Memory}}
      requests:
        cpu: {{.Spec.Resources.Cpu.Min}}
        memory: {{.Spec.Resources.Memory}}

    {{- if .Labels }}
    podLabels: {{.Labels | toYAML| nindent 6}}
    {{- end}}

    {{- if .Spec.NodeSelector }}
    nodeSelector: {{.Spec.NodeSelector | toYAML | nindent 4}}
    {{- end }}

    persistence:
      enabled: true
      size: {{.Spec.Storage.Size}}

  data:
    replicaCount: 0

  coordinating:
    replicaCount: 0

  ingest:
    enabled: false
    replicaCount: 0

  metrics:
    enabled: true
{{- end}}
