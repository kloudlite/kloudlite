{{- $ownerRefs := get . "owner-refs"}}
{{- $storageClass := get . "storage-class"}}
{{- $obj :=  get . "object" }}
{{- $freeze := get . "freeze" | default false}}
{{- $rootPassword := get . "root-password"  -}}

{{- with $obj }}
{{- /* gotype: operators.kloudlite.io/apis/mongodb-standalone.msvc/v1.Service */ -}}
apiVersion: msvc.kloudlite.io/v1
kind: HelmMongoDB
metadata:
  name: {{.Name}}
  namespace: {{.Namespace}}
  {{- if .Labels }}
  labels: {{ .Labels | toYAML | nindent 4 }}
  {{- end}}
  ownerReferences: {{ $ownerRefs | toYAML | nindent 4 }}
spec:
  global:
    storageClass: {{$storageClass}}
  fullnameOverride: {{.Name}}
  image:
    tag: 5.0.8-debian-10-r20

  architecture: standalone
  useStatefulSet: true

  replicaCount: {{ if $freeze}}0{{else}}{{.Spec.ReplicaCount}}{{end}}

  {{- if .Labels }}
  commonLabels: {{.Labels | toYAML | nindent 4}}
  {{- end }}

  {{- if .Spec.NodeSelector}}
  nodeSelector: {{.Spec.NodeSelector | toYAML | nindent 4}}
  {{- end }}

  auth:
    enabled: true
    rootPassword: {{$rootPassword}}

  persistence:
    enabled: true
    size: {{.Spec.Storage.Size}}

  volumePermissions:
    enabled: true

  metrics:
    enabled: true

  livenessProbe:
    enabled: true
    timeoutSeconds: 15

  readinessProbe:
    enabled: true
    initialDelaySeconds: 10
    periodSeconds: 30
    timeoutSeconds: 20

  resources:
    requests:
      cpu: {{.Spec.Resources.Cpu.Min}}
      memory: {{ .Spec.Resources.Memory }}
    limits:
      cpu: {{.Spec.Resources.Cpu.Max}}
      memory: {{.Spec.Resources.Memory}}
{{- end }}
