{{- $ownerRefs := get . "owner-refs"}}
{{- $storageClass := get . "storage-class"}}
{{- $obj :=  get . "object" }}
{{- $freeze := get . "freeze" | default false}}
{{- $rootPassword := get . "root-password"  -}}
{{- $priorityClassName := get . "priority-class-name"  | default "stateful" -}}

{{- with $obj }}
{{- /* gotype: operators.kloudlite.io/apis/mongodb.msvc/v1.StandaloneService*/ -}}
apiVersion: msvc.kloudlite.io/v1
kind: HelmMongoDB
metadata:
  name: {{.Name}}
  namespace: {{.Namespace}}
  {{- if .Labels }}
  labels: {{ .Labels | toYAML | nindent 4 }}
  {{- end}}
  ownerReferences: {{ $ownerRefs | toYAML | nindent 4 }}
spec:
  global:
    storageClass: {{$storageClass}}
  fullnameOverride: {{.Name}}
  image:
    tag: 5.0.8-debian-10-r20

  architecture: standalone
  useStatefulSet: true

  replicaCount: {{ if $freeze}}0{{else}}{{.Spec.ReplicaCount}}{{end}}

  {{- if .Labels }}
  commonLabels: {{.Labels | toYAML | nindent 4}}
  {{- end }}

  podLabels:
    {{if .Labels}}{{.Labels | toYAML | nindent 4}}{{end}}
    kloudlite.io/region: {{.Spec.Region}}
    kloudlite.io/stateful-node: "true"

  {{- if .Spec.NodeSelector}}
  nodeSelector: {{.Spec.NodeSelector | toYAML | nindent 4}}
  {{- end }}

  auth:
    enabled: true
    rootPassword: {{$rootPassword}}

  persistence:
    enabled: true
    size: {{.Spec.Resources.Storage.Size}}

  volumePermissions:
    enabled: true

  metrics:
    enabled: true

  livenessProbe:
    enabled: true
    timeoutSeconds: 15

  readinessProbe:
    enabled: true
    initialDelaySeconds: 10
    periodSeconds: 30
    timeoutSeconds: 20

  priorityClassName: {{$priorityClassName}}
  affinity: {{include "NodeAffinity" (dict) | nindent 4 }}
  tolerations: {{include "RegionToleration" (dict "region" .Spec.Region) | nindent 4}}
  nodeSelector: {{include "RegionNodeSelector" (dict "region" .Spec.Region) | nindent 4}}

  resources:
    requests:
      cpu: {{.Spec.Resources.Cpu.Min}}
      memory: {{ .Spec.Resources.Memory }}
    limits:
      cpu: {{.Spec.Resources.Cpu.Max}}
      memory: {{.Spec.Resources.Memory}}
{{- end }}
