{{- $ownerRefs := get . "owner-refs" }}
{{- $storageClass := get . "storage-class"}}
{{- $obj := get . "object"}}

{{- $generatedVars := mustFromJson ($obj.Status.GeneratedVars | toJson) }}

{{- with $obj }}
{{- /*gotype: operators.kloudlite.io/apis/mysql-standalone.msvc/v1.Service*/ -}}
apiVersion: msvc.kloudlite.io/v1
kind: HelmMySqlDB
metadata:
  name: {{.Name}}
  namespace: {{.Namespace}}
  ownerReferences: {{ $ownerRefs | toYAML | nindent 4 }}
  {{- if .Labels }}
  labels: {{ .Labels | toYAML | nindent 4 }}
  {{- end}}
spec:
  global:
    storageClass: {{$storageClass}}

  fullnameOverride: {{.Name}}
  image:
    tag: 8.0.30-debian-11-r6

  {{- if .Labels }}
  commonLabels: {{.Labels | toYAML | nindent 4}}
  {{- end }}

  {{- if .Spec.NodeSelector}}
  nodeSelector: {{.Spec.NodeSelector | toYAML | nindent 4}}
  {{- end }}

  architecture: standalone
  auth:
    enabled: true
    password: {{ index $generatedVars "mysql-password" }}
    rootPassword: {{ index $generatedVars "mysql-root-password" }}
  primary:
    persistence:
      enabled: true
      size: {{.Spec.Storage.Size}}
    {{- if .Labels }}
    podLabels: {{.Labels | toYAML | nindent 6}}
    {{- end}}

  secondary:
    {{- if .Labels }}
    podLabels: {{.Labels | toYAML | nindent 6}}
    {{- end}}

  resources:
    limits:
      cpu: {{.Spec.Resources.Cpu.Max}}
      memory: {{.Spec.Resources.Memory}}
    requests:
      cpu: {{.Spec.Resources.Cpu.Min}}
      memory: {{.Spec.Resources.Memory}}
{{- end}}
