version: 3

includes:
  go: ../../../../../.tools/taskfiles/go-build.Taskfile.yml

vars:
  binary: service-binding-controller

tasks:
  build:
    cmds:
      - task: go:build
        vars:
          Out: "./bin/{{.binary}}-{{.GOARCH}}"

  run:
    env:
      GATEWAY_ADMIN_API_ADDR: "http://gateway.kl-gateway.svc.cluster.local:8080"
    cmds:
      - go run .

  container:build-and-push:
    preconditions: 
      - sh: '[ -n "{{.image}}" ]'
        msg: "image must be set"
    cmds:
      - GOARCH=amd64 task build
      - GOARCH=arm64 task build
      - docker buildx build --build-arg BINARY=./bin/{{.binary}} --platform linux/amd64,linux/arm64 --output=type=image,compression=zstd,compression-level=12,force-compression=true,push=true -t {{.image}} .
