version: '3.8'

services:
  k3s:
    image: rancher/k3s:v1.28.5-k3s1
    container_name: kloudlite-k3s
    privileged: true
    restart: unless-stopped
    environment:
      # Disable traefik and use lightweight setup
      K3S_KUBECONFIG_MODE: "644"
      K3S_CLUSTER_SECRET: "kloudlite-secret"
      K3S_TOKEN: "kloudlite-token"
    command: >
      server
      --disable=traefik
      --disable=metrics-server
      --disable=servicelb
      --kube-apiserver-arg=feature-gates=CustomResourceValidationExpressions=true
      --kube-apiserver-arg=enable-admission-plugins=ValidatingAdmissionWebhook,MutatingAdmissionWebhook
      --write-kubeconfig=/etc/rancher/k3s/kubeconfig/config.yaml
      --write-kubeconfig-mode=644
    ports:
      # Kubernetes API Server
      - "6443:6443"
      # Kubelet metrics
      - "10250:10250"
    volumes:
      # K3s data
      - k3s-data:/var/lib/rancher/k3s
      # Kubeconfig shared directory
      - ./kubeconfig:/etc/rancher/k3s/kubeconfig
      # CRDs auto-install
      - ./api/crds:/var/lib/rancher/k3s/server/manifests/crds:ro
      # Scripts
      - ./scripts:/scripts:ro
    healthcheck:
      test: ["CMD", "kubectl", "get", "nodes"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - kloudlite-network

volumes:
  k3s-data:
    name: kloudlite-k3s-data

networks:
  kloudlite-network:
    name: kloudlite-network
    driver: bridge